<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Women Safety – Location Survey</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: #f4f5fb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .card {
      background: #ffffff;
      width: 100%;
      max-width: 520px;
      padding: 24px 24px 20px;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    .card-header {
      margin-bottom: 18px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: 13px;
      color: #6b7280;
    }

    .form-group {
      margin-bottom: 14px;
    }

    .field-label-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }

    .field-hint {
      font-size: 11px;
      color: #9ca3af;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }

    /* Native select (used for Area) */
    select {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background-color: #ffffff;
      color: #111827;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      max-height: 220px;
    }

    select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }

    select:disabled {
      background-color: #f3f4f6;
      color: #9ca3af;
      cursor: not-allowed;
    }

    /* Custom searchable dropdown for Police Station */
    .custom-select {
      position: relative;
      margin-top: 4px;
    }

    .select-display {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background-color: #ffffff;
      font-size: 14px;
      color: #111827;
      cursor: pointer;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background-color 0.15s ease;
    }

    .select-display:hover {
      border-color: #9ca3af;
    }

    .select-display:focus-visible {
      outline: 2px solid #2563eb;
      outline-offset: 2px;
    }

    .select-placeholder {
      color: #9ca3af;
      flex: 1;
    }

    .select-value {
      flex: 1;
      margin-right: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .select-arrow {
      margin-left: 8px;
      font-size: 11px;
      color: #6b7280;
    }

    .select-panel {
      position: absolute;
      left: 0;
      right: 0;
      margin-top: 4px;
      background-color: #ffffff;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 14px 45px rgba(15, 23, 42, 0.18);
      padding: 8px;
      z-index: 20;
      display: none;
    }

    .select-panel.open {
      display: block;
    }

    .search-input {
      width: 100%;
      padding: 6px 9px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background-color: #f9fafb;
      color: #111827;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background-color 0.15s ease;
    }

    .search-input::placeholder {
      color: #9ca3af;
    }

    .search-input:focus {
      border-color: #2563eb;
      background-color: #ffffff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.12);
    }

    .select-options {
      list-style: none;
      margin: 6px 0 0;
      padding: 0;
      max-height: 220px;
      overflow-y: auto;
    }

    .select-option {
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
    }

    .select-option:hover {
      background-color: #eff6ff;
      color: #1d4ed8;
    }

    .no-results {
      font-size: 12px;
      color: #6b7280;
      padding: 4px 2px;
    }

    .error-message {
      display: none;
      margin-top: 4px;
      font-size: 12px;
      color: #b91c1c;
    }

    .btn-row {
      margin-top: 6px;
    }

    button[type="submit"] {
      width: 100%;
      padding: 9px 12px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      border: none;
      background-color: #2563eb;
      color: #ffffff;
      cursor: pointer;
      transition: background-color 0.15s ease, transform 0.05s ease;
    }

    button[type="submit"]:hover {
      background-color: #1d4ed8;
    }

    button[type="submit"]:active {
      transform: translateY(1px);
    }

    .success-message {
      display: none;
      margin-top: 12px;
      font-size: 13px;
      color: #166534;
      background: #ecfdf3;
      border-radius: 6px;
      padding: 8px 10px;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-header">
      <div class="card-title">Location Details</div>
      <div class="card-subtitle">
        Select your Police Station and Area for the survey.
      </div>
    </div>

    <form id="surveyForm" novalidate>
      <!-- Custom searchable Police Station dropdown -->
      <div class="form-group">
        <div class="field-label-row">
          <label for="policeStationDisplay">Police Station</label>
          <span class="field-hint">Click to search & select</span>
        </div>

        <div class="custom-select" id="policeStationDropdown">
          <button
            type="button"
            id="policeStationDisplay"
            class="select-display"
          >
            <span id="policeStationPlaceholder" class="select-placeholder">
              Select Police Station
            </span>
            <span
              id="policeStationValue"
              class="select-value"
              style="display: none"
            ></span>
            <span class="select-arrow">▾</span>
          </button>

          <div class="select-panel" id="policeStationPanel">
            <input
              type="text"
              id="policeStationSearch"
              class="search-input select-search"
              placeholder="Search police station..."
              autocomplete="off"
            />
            <ul id="policeStationOptions" class="select-options">
              <!-- Stations will be rendered here -->
            </ul>
            <div
              id="policeStationNoResults"
              class="no-results"
              style="display: none"
            >
              No stations found.
            </div>
          </div>
        </div>

        <!-- Hidden field that actually stores the value for the form -->
        <input type="hidden" id="policeStation" name="policeStation" />

        <div id="policeStationError" class="error-message">
          Please select a Police Station.
        </div>
      </div>

      <div class="form-group">
        <div class="field-label-row">
          <label for="area">Area / Village</label>
          <span class="field-hint">Updates from Police Station</span>
        </div>
        <select id="area" name="area" disabled>
          <option value="">-- Select Area --</option>
          <!-- Area options will be added dynamically -->
        </select>
        <div id="areaError" class="error-message">
          Please select an Area.
        </div>
      </div>

      <div class="btn-row">
        <button type="submit">Submit</button>
      </div>

      <div id="successMessage" class="success-message"></div>
    </form>
  </div>

  <!-- Load the large Police Station -> Area mapping -->
  <script src="mapping.js"></script>

  <script>
    // `policeStationAreas` is defined globally in `mapping.js`.
    // This script wires it to a custom searchable dropdown for
    // Police Station and a normal dropdown for Area.

    // Form + error elements
    const form = document.getElementById("surveyForm");
    const policeStationError = document.getElementById("policeStationError");
    const areaError = document.getElementById("areaError");
    const successMessage = document.getElementById("successMessage");

    // Hidden field that stores the selected Police Station
    const policeStationInput = document.getElementById("policeStation");

    // Custom dropdown elements
    const psDropdown = document.getElementById("policeStationDropdown");
    const psDisplayButton = document.getElementById("policeStationDisplay");
    const psPlaceholder = document.getElementById("policeStationPlaceholder");
    const psValueSpan = document.getElementById("policeStationValue");
    const psPanel = document.getElementById("policeStationPanel");
    const psSearchInput = document.getElementById("policeStationSearch");
    const psOptionsList = document.getElementById("policeStationOptions");
    const psNoResults = document.getElementById("policeStationNoResults");

    // Area select
    const areaSelect = document.getElementById("area");

    // Helper: trim + lowercase, useful for deduplication
    function normalizeName(name) {
      return name.trim().toLowerCase();
    }

    // Render Police Station options into the custom dropdown list
    function renderPoliceStationOptions(filterText = "") {
      psOptionsList.innerHTML = "";
      psNoResults.style.display = "none";

      const term = filterText.trim().toLowerCase();

      const stationNames = Object.keys(policeStationAreas)
        .filter((name) =>
          term ? name.toLowerCase().includes(term) : true
        )
        .sort((a, b) => a.localeCompare(b));

      if (stationNames.length === 0) {
        psNoResults.style.display = "block";
        return;
      }

      stationNames.forEach((stationName) => {
        const li = document.createElement("li");
        li.textContent = stationName;
        li.className = "select-option";

        li.addEventListener("click", () => {
          // Store the value
          policeStationInput.value = stationName;

          // Update display text
          psValueSpan.textContent = stationName;
          psValueSpan.style.display = "inline";
          psPlaceholder.style.display = "none";

          // Clear any previous error message
          policeStationError.style.display = "none";

          // When station changes, refresh areas
          populateAreasForStation(stationName);
          areaError.style.display = "none";

          closePoliceStationPanel();
        });

        psOptionsList.appendChild(li);
      });
    }

    function openPoliceStationPanel() {
      psPanel.classList.add("open");
      psSearchInput.value = "";
      renderPoliceStationOptions("");
      psSearchInput.focus();
    }

    function closePoliceStationPanel() {
      psPanel.classList.remove("open");
    }

    // Populate Areas dropdown for a selected Police Station
    function populateAreasForStation(stationName) {
      areaSelect.innerHTML =
        '<option value="">-- Select Area --</option>';

      if (!stationName) {
        areaSelect.disabled = true;
        return;
      }

      const rawAreas = policeStationAreas[stationName] || [];
      const seen = new Set(); // for duplicate removal

      rawAreas.forEach((raw) => {
        if (typeof raw !== "string") return;

        const trimmed = raw.trim();
        if (!trimmed) return; // skip empty after trimming

        const key = normalizeName(trimmed);
        if (seen.has(key)) return; // skip duplicates

        seen.add(key);

        const option = document.createElement("option");
        option.value = trimmed; // keep exact name (trimmed)
        option.textContent = trimmed;
        areaSelect.appendChild(option);
      });

      // Enable only if we actually have areas beyond the placeholder
      areaSelect.disabled = areaSelect.options.length <= 1;
    }

    // Toggle open/close when the main display is clicked
    psDisplayButton.addEventListener("click", () => {
      const isOpen = psPanel.classList.contains("open");
      if (isOpen) {
        closePoliceStationPanel();
      } else {
        openPoliceStationPanel();
      }
    });

    // Close when clicking outside the dropdown
    document.addEventListener("click", (event) => {
      if (!psDropdown.contains(event.target)) {
        closePoliceStationPanel();
      }
    });

    // Filter police stations as the user types
    psSearchInput.addEventListener("input", function () {
      renderPoliceStationOptions(this.value);
    });

    // Clear Area error when user chooses an Area
    areaSelect.addEventListener("change", function () {
      if (this.value) {
        areaError.style.display = "none";
      }
    });

    // Basic validation on submit
    form.addEventListener("submit", function (event) {
      event.preventDefault();

      policeStationError.style.display = "none";
      areaError.style.display = "none";
      successMessage.style.display = "none";

      const selectedStation = policeStationInput.value;
      const selectedArea = areaSelect.value;

      let isValid = true;

      if (!selectedStation) {
        policeStationError.style.display = "block";
        isValid = false;
      }

      if (!selectedArea) {
        areaError.style.display = "block";
        isValid = false;
      }

      if (!isValid) {
        return;
      }

      successMessage.textContent =
        "Selected Police Station: " +
        selectedStation +
        " | Area: " +
        selectedArea;
      successMessage.style.display = "block";
    });

    // ---- Initial setup ----
    renderPoliceStationOptions("");
    areaSelect.disabled = true;
  </script>
</body>
</html>